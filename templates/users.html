{% extends "base.html" %}

{% block title %}用户列表{% endblock %}

{% block content %}
<h2>用户列表</h2>

<div class="row mb-3">
    <div class="col-md-6">
        <form class="d-flex" action="{{ url_for('list_users') }}" method="get">
            <input class="form-control me-2" type="search" placeholder="搜索用户名/邮箱..." aria-label="Search" name="search_query" value="{{ search_query }}">
            <input type="hidden" name="page_size" value="{{ page_size }}">
            <button class="btn btn-outline-success" type="submit">搜索</button>
        </form>
    </div>
    <div class="col-md-6 text-end">
        <a href="{{ url_for('add_user') }}" class="btn btn-primary">添加用户</a>
    </div>
</div>

{% if error %}
    <div class="alert alert-danger">{{ error }}</div>
{% elif users %}
<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>ID</th>
            <th>用户名</th>
            <th>邮箱</th>
            <th>注册日期</th>
            <th>最后登录</th>
            <th>操作</th>
        </tr>
    </thead>
    <tbody>
        {% for user in users %}
        <tr>
            <td>{{ user.user_id[:8] }}...</td>
            <td>{{ user.username }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.registration_date }}</td>
            <td>{{ user.last_login }}</td>
            <td>
                <a href="{{ url_for('user_detail', user_id=user.user_id) }}" class="btn btn-info btn-sm">查看</a>
                <a href="{{ url_for('edit_user', user_id=user.user_id) }}" class="btn btn-warning btn-sm">编辑</a>
                <form action="{{ url_for('delete_user', user_id=user.user_id) }}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('您确定要删除用户 {{ user.username }} 吗？此操作不可逆！');">删除</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- 分页控件 -->
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_users', page=current_page-1, page_size=page_size, search_query=search_query) }}">上一页</a>
        </li>
        <!-- 页码下拉框 -->
        <li class="page-item">
            <select class="form-select" onchange="window.location.href = this.value;">
                {% for p in range(1, total_pages + 1) %}
                    <option value="{{ url_for('list_users', page=p, page_size=page_size, search_query=search_query) }}" {% if p == current_page %}selected{% endif %}>
                        {{ p }} / {{ total_pages }}
                    </option>
                {% endfor %}
            </select>
        </li>
        <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('list_users', page=current_page+1, page_size=page_size, search_query=search_query) }}">下一页</a>
        </li>
    </ul>
</nav>

{% else %}
    <p>没有用户数据。请前往 <a href="{{ url_for('data_management') }}">数据管理</a> 页面生成数据。</p>
{% endif %}
{% endblock %}